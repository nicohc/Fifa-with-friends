<h1>Profil du joueur : <%= @player.pseudo %></h1>

<div class="title_w_bg">Statistiques </div>
<br>
<table class="leaderboard">
  <tr>
    <th> </th>
    <th> </th>
    <th>Pts</th>
    <th>J.</th>
    <th>G.</th>
    <th>G.pr</th>
    <th>G.pn.</th>
    <th>D.</th>
    <th>D.pr</th>
    <th>D.pn.</th>
    <th>Diff.</th>
    <th>bp.</th>
    <th class="lb_br">bc.</th>
  </tr>
  <br>

  <tr>
    <td></td>
    <td class="lead_team"><%= @player.pseudo %></td>
    <td><b><%= @player.points %></b></td>
    <td class="lb_br"><%= @player.teams.count %> </td>
    <td><%= @player.win %> </td>
    <td><%= @player.win_prol %> </td>
    <td class="lb_br"><%= @player.win_peno %> </td>
    <td><%= @player.lose %> </td>
    <td><%= @player.lose_prol %> </td>
    <td class="lb_br"><%= @player.lose_peno %> </td>
    <td><%= (Team.all.where("player_id= '#{@player.id}'").sum(:score))-((Team.where("player_id= '#{@player.id}'").collect{|a| a.match.teams.collect{|b| b.score}.sum }.sum)-(Team.all.where("player_id= '#{@player.id}'").sum(:score))) %>
    <td><%= Team.all.where("player_id= '#{@player.id}'").sum(:score) %></td>
    <td class="lb_br"><%= (Team.where("player_id= '#{@player.id}'").collect{|a| a.match.teams.collect{|b| b.score}.sum }.sum)-(Team.all.where("player_id= '#{@player.id}'").sum(:score)) %></td>
  </tr>

  <tr>
    <td colspan = 4></td>
    <td colspan = 3><%= @player.win + @player.win_prol + @player.win_peno %> Victoires </td>
    <td colspan = 3><%= @player.lose + @player.lose_prol + @player.lose_peno %> Défaites </td>
    <td colspan = 3></td>
  </tr>

  <tr>
    <td colspan = 2>Rencontres directes</td>
    <td colspan = 11>... à partir du match n°82</td>
  </tr>

  <% @players.ids.each { |pl|  %>
    <% if !(@player.id == pl) %>
    <tr>
        <td></td>
        <td class="lead_team" colspan = 3 > vs. <%= Player.find(pl).pseudo %> : </td>
        <% rencontre = Match.includes(:teams).where("teams.player_id": [pl, @player.id]).references(:teams).ids.each_with_object(Hash.new(0)) { |rencontre,counts| counts[rencontre] += 1 }.select{|k,v| v == 2}.keys %>
        <% if rencontre.empty? %>
          <td colspan = 6>Pas de rencontre entre ces deux joueurs.</td>
          <td colspan = 3></td>

        <% else %>
          <% mixmatches = rencontre.each_with_object(Hash.new(0)) { |r,counts| counts[@player.teams.where(match_id:r).first.status] += 1 } %>
          <td colspan = 3><%= mixmatches["winner"] %> Victoire(s) </td>
          <td colspan = 3><%= mixmatches["loser"] %> Défaite(s) </td>
          <td colspan = 3></td>
        <% end %>
    </tr>
    <% end %>
  <% } %>

</table>

<!--
<div class="title_w_bg">Rencontres directes </div>
<br>
<div id="country">
<%= select_tag :player,
    options_for_select(@players.collect{|p| [p.pseudo, p.id]},
    selected: params[:player]),
    prompt: "Selectionner un adversaire", class: "form-control",
    onchange: 'your_onchange_handler()' %>
</div>
-->

<div class="title_w_bg">Equipes les plus utilisées </div>
<br>
<% club = @player.teams.each_with_object(Hash.new(0)) do |tm,counts| counts[tm.club.name]+= 1 end %>
<% sortcountclub = club.sort_by{|k,v| v}.reverse%>
<% sortcountclub.take(5).each{ |a,b| %>
  <%= a %>, <%= b %> fois.
  <br>
<% } %>

<br>
<div class="title_w_bg">Records et chiffres </div>
<br>- Record de buts marqués en un match : <%= maxgoal = @player.teams.maximum("score") %>
<br>
<table class="scoreboard">
  <tr>
    <th>ID du match</th>
    <th>Joueur 1</th>
    <th>Team 1</th>
    <th>Score</th>
    <th>Team 2</th>
    <th>Joueur 2</th>
  </tr>
  <br>
  <% match_maxgoal = @player.teams.where(score: maxgoal).first.match %>
  <tr>
    <td><%= match_maxgoal.id %></td>
    <td><%= link_to Player.find(match_maxgoal.teams.first.player_id).pseudo, player_path(match_maxgoal.teams.first.player_id) %> </td>
    <% if match_maxgoal.teams.first.status == "winner" %>
      <td class="statuswinner"><%= match_maxgoal.teams.first.club.name %></td>
      <% else %>
      <td><%= match_maxgoal.teams.first.club.name %></td>
    <% end %>
    <td><div class="tab_score">
          <%= match_maxgoal.teams.first.score %> - <%= match_maxgoal.teams.last.score %>
        </div>
        <span class="tab_score_prol">
        <%= (match_maxgoal.prolongations && !match_maxgoal.teams.first.prol_score) ? "a.p" : "" %>
        <%= match_maxgoal.teams.first.prol_score %><%= match_maxgoal.teams.first.prol_score == nil ? '' : ' tab ' %><%= match_maxgoal.teams.last.prol_score %>
        </span>
    </td>

    <% if match_maxgoal.teams.last.status == "winner" %>
      <td class="statuswinner"><%= match_maxgoal.teams.last.club.name %></td>
      <% else %>
      <td><%= match_maxgoal.teams.last.club.name %></td>
    <% end %>
    <td><%= link_to Player.find(match_maxgoal.teams.last.player_id).pseudo, player_path(match_maxgoal.teams.last.player_id) %> </td>

  </tr>
</table>

<br>
<div class="title_w_bg">Tous les matchs du joueur</div>
<table class="scoreboard">
  <tr>
    <th>ID du match</th>
    <th>Joueur 1</th>
    <th>Team 1</th>
    <th>Score</th>
    <th>Team 2</th>
    <th>Joueur 2</th>
    <!--
    <th>Résultat</th>
    -->
  </tr>
  <br>
  <% Match.includes(:players).where("players.id = ?", @player.id).references(:players).each { |match| %>

    <% if match.teams.empty? %>
    <tr>
      <td><%= match.id %></td>
      <td>Pas de match enegistré...</td>
    </tr>
    <% else %>
    <tr>
      <td><%= match.id %></td>
      <td><%= link_to Player.find(match.teams.first.player_id).pseudo, player_path(match.teams.first.player_id) %> </td>
      <% if match.teams.first.status == "winner" %>
        <td class="statuswinner"><%= match.teams.first.club.name %></td>
        <% else %>
        <td><%= match.teams.first.club.name %></td>
      <% end %>
      <td><div class="tab_score">
            <%= match.teams.first.score %> - <%= match.teams.last.score %>
          </div>
          <span class="tab_score_prol">
          <%= (match.prolongations && !match.teams.first.prol_score) ? "a.p" : "" %>
          <%= match.teams.first.prol_score %><%= match.teams.first.prol_score == nil ? '' : ' tab ' %><%= match.teams.last.prol_score %>
          </span>
      </td>

      <% if match.teams.last.status == "winner" %>
        <td class="statuswinner"><%= match.teams.last.club.name %></td>
        <% else %>
        <td><%= match.teams.last.club.name %></td>
      <% end %>
      <td><%= link_to Player.find(match.teams.last.player_id).pseudo, player_path(match.teams.last.player_id) %> </td>

    </tr>
  <% end %>
  <% } %>

</table>

<br><br>
<%= link_to "Accueil", root_path %>
